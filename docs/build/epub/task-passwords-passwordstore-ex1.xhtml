<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>Example 1: Update userpass, or create it if does not exists</title>
    <link rel="stylesheet" href="_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> 
  </head><body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="example-1-update-userpass-or-create-it-if-does-not-exists">
<h1>Example 1: Update userpass, or create it if does not exists</h1>
<p>Let’s start with no passwords stored in <span class="target" id="index-0"></span>passwordstore for users at host <em>test_01</em>. The command
show no results</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="l l-Scalar l-Scalar-Plain">shell&gt; pass test_01</span>
</span></pre></div>
</div>
<p>Create a playbook</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="l l-Scalar l-Scalar-Plain">shell&gt; cat linux-postinstall.yml</span>
</span><span class="l l-Scalar l-Scalar-Plain">- hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_01</span>
  <span class="l l-Scalar l-Scalar-Plain">become</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">vbotka.linux_postinstall</span>
</pre></div>
</div>
<p>Create <em>host_vars/test_01/lp-users.yml</em> with two users <em>user1</em> and
<em>user2</em></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="hll"> <span class="l l-Scalar l-Scalar-Plain">shell&gt; cat host_vars/test_01/lp-users.yml</span>
</span> <span class="l l-Scalar l-Scalar-Plain">lp_users</span><span class="p p-Indicator">:</span>
   <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nt">name</span><span class="p">:</span> <span class="nv">user1</span><span class="p p-Indicator">,</span><span class="nt"> shell</span><span class="p">:</span> <span class="nv">/bin/sh</span><span class="p p-Indicator">}</span>
   <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class="nt">name</span><span class="p">:</span> <span class="nv">user2</span><span class="p p-Indicator">,</span><span class="nt"> shell</span><span class="p">:</span> <span class="nv">/bin/bash</span><span class="p p-Indicator">}</span>
</pre></div>
</div>
<p>Create users. This step will create these two users and configure
their login shell. Other paramteres of the Annsible module <a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/user_module.html">user</a><span class="link-target"> [https://docs.ansible.com/ansible/latest/modules/user_module.html]</span>
will be ommited because the only required parameter is <em>name</em>. It’s a
good idea to create one account with the login shell <em>/bin/sh</em> and use
it as Ansible <a class="reference external" href="https://docs.ansible.com/ansible/2.4/become.html#become">remote_user</a><span class="link-target"> [https://docs.ansible.com/ansible/2.4/become.html#become]</span>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="hll"> <span class="l l-Scalar l-Scalar-Plain">shell&gt; ansible-playbook linux-postinstall.yml -t lp_users</span>
</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
 <span class="l l-Scalar l-Scalar-Plain">TASK [vbotka.linux_postinstall</span> <span class="p p-Indicator">:</span> <span class="nt">users</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Manage user accounts] *********</span>
 <span class="nt">changed</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">test_01</span><span class="p p-Indicator">]</span> <span class="l l-Scalar l-Scalar-Plain">=&gt; (item=user1)</span>
 <span class="nt">changed</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">test_01</span><span class="p p-Indicator">]</span> <span class="l l-Scalar l-Scalar-Plain">=&gt; (item=user2)</span>
</pre></div>
</div>
<p>Create <em>host_vars/test_01/lp-passwords.yml</em></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="hll"> <span class="l l-Scalar l-Scalar-Plain">shell&gt; cat host_vars/test_01/lp-passwords.yml</span>
</span> <span class="l l-Scalar l-Scalar-Plain">lp_passwords</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
 <span class="nt">lp_passwordstore</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
 <span class="nt">lp_passwordstore_create</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
 <span class="nt">lp_passwordstore_overwrite</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<p>Create passwords. This step will use <em>passwordstore</em> to create the passwords and configure them. New passwords will be created only if allowed by the configuration of <em>lp_passwordstore_create</em>. We set this variable to <em>True</em> in this command but keep it <em>False</em> in the configuration to keep the passwords once created. The value of <em>lp_passwordstore_overwrite</em> is <em>False</em>. New passwords will be assigned to the users if no passwords have been assigned to the users before. To change the passwords in the future set both variables <em>True</em> on the commandline.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="l l-Scalar l-Scalar-Plain">shell&gt; ansible-playbook linux-postinstall.yml -t lp_passwords \</span>
</span><span class="hll">                                       <span class="l l-Scalar l-Scalar-Plain">-e &#39;lp_passwordstore_create=True&#39;</span>
</span><span class="nn">...</span>

<span class="l l-Scalar l-Scalar-Plain">TASK [vbotka.ansible_lib</span> <span class="p p-Indicator">:</span> <span class="nt">al_pws_user_host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Retrieve, create or update ...]</span>
<span class="nt">ok</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">test_01</span><span class="p p-Indicator">]</span> <span class="l l-Scalar l-Scalar-Plain">=&gt; (item=user1)</span>
<span class="nt">ok</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">test_01</span><span class="p p-Indicator">]</span> <span class="l l-Scalar l-Scalar-Plain">=&gt; (item=user2)</span>
<span class="nn">...</span>
<span class="l l-Scalar l-Scalar-Plain">TASK [vbotka.linux_postinstall</span> <span class="p p-Indicator">:</span> <span class="nt">users</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Manage user accounts] **********</span>
<span class="nt">changed</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">test_01</span><span class="p p-Indicator">]</span> <span class="l l-Scalar l-Scalar-Plain">=&gt; (item=user1)</span>
<span class="nt">changed</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">test_01</span><span class="p p-Indicator">]</span> <span class="l l-Scalar l-Scalar-Plain">=&gt; (item=user2)</span>
</pre></div>
</div>
<p>The command is idempotent</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="hll">shell&gt; ansible-playbook linux-postinstall.yml -t lp_passwords
</span>...
PLAY RECAP *************************************************************
test_01: <span class="nv">ok</span><span class="o">=</span><span class="m">18</span> <span class="nv">changed</span><span class="o">=</span><span class="m">0</span> <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span> <span class="nv">failed</span><span class="o">=</span><span class="m">0</span> <span class="nv">skipped</span><span class="o">=</span><span class="m">20</span> <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span> ...
</pre></div>
</div>
<p>Show the passwords stored in <em>passwordstore</em> at the controller</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="hll">shell&gt; pass test_01
</span>test_01
├── user1
└── user2

<span class="hll">shell&gt; pass test_01/user1
</span>1rLy0eVpJiTpzj-4
lookup_pass: First generated by ansible on <span class="m">01</span>/07/2020 <span class="m">16</span>:59:00

<span class="hll">shell&gt; pass test_01/user2
</span>u4FLTCkKOHAyJxkg
lookup_pass: First generated by ansible on <span class="m">01</span>/07/2020 <span class="m">16</span>:59:00
</pre></div>
</div>
<p>Show the <em>passwordstore</em> log at the controller</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="hll">shell&gt; <span class="nb">cd</span> ~/.password-store
</span><span class="hll">shell&gt; git log
</span>
commit 61bb8bcd7c2a359f53c8b3d4bacb8854b4dd9f89 <span class="o">(</span>HEAD -&gt; master<span class="o">)</span>
Author: Vladimir Botka &lt;vbotka@gmail.com&gt;
Date:   Wed Jul <span class="m">1</span> <span class="m">16</span>:59:00 <span class="m">2020</span> +0200

    Add given password <span class="k">for</span> test_01/user2 to store.

commit 97b23a5221e721fb892d739b2817923a6db8614b
Author: Vladimir Botka &lt;vbotka@gmail.com&gt;
Date:   Wed Jul <span class="m">1</span> <span class="m">16</span>:59:00 <span class="m">2020</span> +0200

    Add given password <span class="k">for</span> test_01/user1 to store.
</pre></div>
</div>
<p>Show the created users at the remote host</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="hll">test_01&gt; grep user /etc/passwd
</span>user1:x:1003:1003::/home/user1:/bin/sh
user2:x:1004:1004::/home/user2:/bin/bash
</pre></div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>